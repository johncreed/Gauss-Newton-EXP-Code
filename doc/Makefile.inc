# 
# Common bits for building LaTeX files, for both BSD make and GNU make.
#
# Written by Rong-En Fan based on previous group member's Makefile for
# the same purpose. Feel free to use it, send me any feedbacks.
#
# -- Rong-En Fan <b90098@csie.ntu.edu.tw>
# Last Modified: May 25, 2007
#

#
# TARGETS
#
# clean: remove generated files by LaTeX. See CLEAN_FILES variable
#
# web: copy files listed in FILES variable to ~/htdocs/tmp
#
# VARIABLES
#
# CLEAN_FILES: extra files to be removed in 'make clean'. The default is
#              those are generated by LaTeX.
#
# TEX_DEPS: list all files used in your tex file
#

#
# Example usage:
#
# FILES = thesis.pdf
#
# TEX_DEPS = *.tex *.sty *.bib table/*.tex
# CLEAN_FILES = *.cjk
#
# all:	$(FILES)
#
# include Makefile.inc
#

LATEX ?= xelatex --shell-escape
PDFLATEX ?= pdflatex --shell-escape
BIBTEX ?= bibtex 

# rules

# TODO This should be automatically determined
TEX_DEPS += *.tex

CLEAN_FILES += *.cjk *.log *.aux *.out *.ilg *.ind *.lof *.lot *.toc \
		*.bbl *.blg \
		*.dvi *.ps 

.SUFFIXES: .tex .dvi .ps .pdf .jpg .eps

$(FILES): $(TEX_DEPS)

.tex.pdf: $(TEX_DEPS)
	-${PDFLATEX} $*.tex
	-${BIBTEX} $*
	-${PDFLATEX} $*.tex
	${PDFLATEX} $*.tex
	${PDFLATEX} $*.tex
	@echo ""
	@echo "===> All warnings:"
	@echo ""
	@(grep 'Warning' $*.log | grep -v 'PDFDocEncode') || true

.tex.dvi: $(TEX_DEPS)
	$(LATEX) $*.tex
	$(BIBTEX) $*
	$(LATEX) $*.tex
	$(LATEX) $*.tex
	$(LATEX) $*.tex
	@echo ""
	@echo "===> All warnings:"
	@echo ""
	@(grep 'Warning' $*.log | grep -v 'PDFDocEncode') || true

.dvi.ps:
	dvips -o $*.ps  $*.dvi

.jpg.eps: $*.jpg
	@if [ ! -z `which djpeg` ]; then \
	  djpeg -grayscale $*.jpg | pnmtops > $*.eps; \
	else \
	  echo "djpeg is not available, use jpegtopnm instead."; \
	  jpegtopnm $*.jpg | ppmtopgm | pnmtops > $*.eps; \
	fi

# targets
clean:
	rm -f $(CLEAN_FILES) *~

web:
	@echo "Copying $(FILES) into ~/htdocs/tmp"
	@cp $(FILES) $$HOME/htdocs/tmp/

# vim:syntax=make
